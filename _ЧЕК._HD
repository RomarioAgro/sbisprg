# обработчик диалога 'Чек'
Функция 'Чек'(Событие,Поле)
{
#   Сообщить(Событие+"\n"+Поле);
   ВыборПо(Событие)
   {
      Выбор "Инициализация":
         @СуммаСкидки=0;
         ДляВсех(Наименований)
               @СуммаСкидки+=НачЦена*Кол_во-СуммаЦен;
         пКолСим=0;
         Если('Папки.Тема'=="ПРОДАЖА") Документ.Тема="01";
         Иначе Документ.Тема="0"+Подстрока('Папки.Тема',6,1);
         Если(Есть('Правила-Документы')==-1)
         {
            оПрав=Выборка("Правила операций");
            оПрав.Имя="РТ_ПРОД";
            Найти(оПрав,"Имя");
            Связать('Правила-Документы',оПрав);
            Очистить(оПрав);
         } 
         Если(!Документ.Сумма)
         {
            оЛицо=Лицо("XЧЛ","Частные лица");
            Связать(Лицо1,оЛицо);
            Очистить(оЛицо);
            Связать(Лицо2,оЛицо);
         } 
         Поле="@СИМ1";
         Вернуть Поле;
      Выбор "Изменение":
         Если(Поле=="@СИМ1")
         {
         '@Штрих-Код'='@Штрих-Код'+@СИМ1;
         @СИМ1="";
         пКолСим++;
         Если(Подстрока('@Штрих-Код',1,2)=="77" или Подстрока('@Штрих-Код',1,2)=="78" 
         или Подстрока('@Штрих-Код',1,2)=="43" или Подстрока('@Штрих-Код',1,2)=="32") 
            {
               пСч=0;
               @Знач="";
               Пока(пСч!=Размер('@Штрих-Код')) 
                  {
                     @Знач=@Знач+"*";
                     пСч++;
                  }
            }
         Иначе @Знач='@Штрих-Код';
         Поле="@СИМ1";
         Вернуть Поле;
         }
         Вернуть "";
      Выбор "Сохранение":
         Поле="";
         Если('@Штрих-Код'!="")
         {
            Если('@Штрих-Код'=="12345")
               {
#                  Сообщить("Карта оформлена на:\n"+Лицо1.ФИО+"");
                 '@Штрих-Код'="";
                  @Знач="";
                  @СИМ1="";
                  Поле="@СИМ1";
                  Вернуть Поле;
               }
            Если(ПодСтрока('@Штрих-Код',1,2)=="77" или Подстрока('@Штрих-Код',1,2)=="78" 
            или Подстрока('@Штрих-Код',1,2)=="43" или Подстрока('@Штрих-Код',1,2)=="32")
               {
                  _ПровКартДиск();
                  пКод=ПодСтрока('@Штрих-Код',1,12);
                  '@Штрих-Код'="";
                  оЧЛ = Объект( "Частные лица" );
                  оЧЛ.ИНН=пКод;
                  Найти(оЧЛ,"ИНН");
#                  отладить();
                  Если(оЧЛ.ИНН==пКод)
                     Если(оЧЛ.ФИО!=оЧЛ.Название И 'оЧЛ.Год рождения'!="")
                        {
                           оЛицо=Лицо(пКод,"Частные лица");
                           Связать(Лицо1,оЧЛ);
#                           Документ.Примечание=оЧЛ.ФИО;
#Проверка занесены ли все данные покупателя или нет
#и если данные не полны, а последний раз анкету предлагали дозаполнить
#больше чем 90 дней назад то предлагаем ищо раз заполнить
                           Если('ОЧЛ.ДЗ'=="")
                              {
                                 'ОЧЛ.ДЗ'=ТекДат;
                                 Сохранить(ОЧЛ);
                              }
                           пПослед=ТекДат-Дата('ОЧЛ.ДЗ');
                           Если(пПослед>90)
                           {
                              Разбить('ОЧЛ.Примечание',"|",пКодСлово,пТел);
                              Разбить('ОЧЛ.Паспорт',",",пЧтото,пЧтотоеще,пЧтото2,пДатаРожд);
                              Если('ОЧЛ.Адрес'=="" или 'ОЧЛ.ФИО'=="" или пТел=="" или пДатаРожд=="")
                                 {
                                    Сообщить("Данные владельца занесены не полностью");
                                    'ОЧЛ.ДЗ'=ТекДат;
                                    Сохранить(ОЧЛ);
                                    пИмя  = "DISC"+КАСНОМ;
                                    оФайл = Объект( "d:\\files\\"+пИмя+".TXT");
                                    оФайл.Строка=ТекВремя+";"+оЧЛ.ИНН+";"+оЧЛ.ФИО+";"+оЧЛ.Название+";"+'оЧЛ.Год рождения'+";"+ОЧЛ.Паспорт+";"+'ОЧЛ.Адрес'+";"+'ОЧЛ.Примечание'+";"+'ОЧЛ.ДЗ';
                                    Добавить(оФайл);
                                    Очистить(оФайл);
                                    оФайл=НЕТ;
                                 
                                 }
                           }
#Конец проверки                   
                           Очистить(оЧЛ);
                           ВыполнитьМакрос("ДИСКАКТ");
                        }
                     Иначе Сообщить("Карта №"+оЧЛ.Название+" не Активирована!");
                  Иначе Сообщить("Нет такой карты!");
               }
            Иначе _ДобавитьНаимПоКодуРасх();
                 '@Штрих-Код'="";
                  @Знач="";
                  @СИМ1="";
            Поле="@СИМ1";
#            Отладить();
            _Продажа();
            Вернуть Поле;
         }
         Вернуть "";
   }
   Вернуть "";
}
