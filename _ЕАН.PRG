Функция _ЕАН(пШКод)

# Функция создана для шрифта EAN-13.TTF
# MD5=c48ac96356e833ac9fd638d5ba973683
#  ╔═╤═╤═╤═╤═╤═╤═╤═╤═╤═╤═╗
#  ║L│0│1│2│3│4│5│6│7│8│9║
#  ╟─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─╢
#  ║G│@│A│B│C│D│E│F│G│H│I║
#  ╟─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─╢
#  ║R│P│Q│R│S│T│U│V│W│X│Y║
#  ╟─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─╢
#  ║<│`│a│b│c│d│e│f│g│h│i║
#  ╟─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─╢
#  ║>│p│q│r│s│t│u│v│w│x│y║
#  ╟─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─╢
#  ║ │!│"│#│$│%│&│'│(│)│*║
#  ╚═╧═╧═╧═╧═╧═╧═╧═╧═╧═╧═╝
# Таблица коэфициентов для расчета контрольного числа
#  ╔═════╤══╤══╤══╤══╤══╤══╤══╤══╤══╤══╤══╤══╤══╗
#  ║ean13│13│12│11│10│09│08│07│06│05│04│03│02│01║
#  ║     │ 4│ 6│ 0│ 0│ 0│ 5│ 1│ 0│ 0│ 0│ 0│ 5│ K║
#  ╟─────┼──┼──┼──┼──┼──┼──┼──┼──┼──┼──┼──┼──┼──╢
#  ║ean8 │  │  │  │  │  │08│07│06│05│04│03│02│01║
#  ║     │  │  │  │  │  │ 4│ 6│ 0│ 0│ 9│ 3│ 3│ K║
#  ╟─────┼──┼──┼──┼──┼──┼──┼──┼──┼──┼──┼──┼──┼──╢
#  ║Коэф │ 1│ 3│ 1│ 3│ 1│ 3│ 1│ 3│ 1│ 3│ 1│ 3│ 1║
#  ╚═════╧══╧══╧══╧══╧══╧══╧══╧══╧══╧══╧══╧══╧══╝
# Структура кода ЕАН13
#  ╔═╤══════╤══════╦═╤══════╤══════╗
#  ║0│LLLLLL│RRRRRR║5│LGGLLG│RRRRRR║
#  ╟─┼──────┼──────╫─┼──────┼──────╢
#  ║1│LLGLGG│RRRRRR║6│LGGGLL│RRRRRR║
#  ╟─┼──────┼──────╫─┼──────┼──────╢
#  ║2│LLGGLG│RRRRRR║7│LGLGLG│RRRRRR║
#  ╟─┼──────┼──────╫─┼──────┼──────╢
#  ║3│LLGGGL│RRRRRR║8│LGLGGL│RRRRRR║
#  ╟─┼──────┼──────╫─┼──────┼──────╢
#  ║4│LGLLGG│RRRRRR║9│LGGLGL│RRRRRR║
#  ╚═╧══════╧══════╩═╧══════╧══════╝
# Кодирование цифр
#  ╔═╤═══════╤═══════╤═══════╦═╤═══════╤═══════╤═══════╗
#  ║ │   L   │   G   │   R   ║ │   L   │   G   │   R   ║
#  ╟─┼───────┼───────┼───────╫─┼───────┼───────┼───────╢
#  ║0│0001101│0100111│1110010║5│0110001│0111001│1001110║
#  ╟─┼───────┼───────┼───────╫─┼───────┼───────┼───────╢
#  ║1│0011001│0110011│1100110║6│0101111│0000101│1010000║
#  ╟─┼───────┼───────┼───────╫─┼───────┼───────┼───────╢
#  ║2│0010011│0011011│1101100║7│0111011│0010001│1000100║
#  ╟─┼───────┼───────┼───────╫─┼───────┼───────┼───────╢
#  ║3│0111101│0100001│1000010║8│0110111│0001001│1001000║
#  ╟─┼───────┼───────┼───────╫─┼───────┼───────┼───────╢
#  ║4│0100011│0011101│1011100║9│0001011│0010111│1110100║
#  ╚═╧═══════╧═══════╧═══════╩═╧═══════╧═══════╧═══════╝
{
#   пШКод=Текст(Число(пШКод));
   Если(Размер(пШКод)==12 ИЛИ Размер(пШКод)==7)
      {
         pL   = "0123456789";
         pG   = "@ABCDEFGHI";
         pR   = "PQRSTUVWXY";
         пРез = "";
      
         пСч=0;
         пКонтр=0;
         Пока(пСч<Размер(пШКод))
            Если(!Найти(Текст(пСч/2),".")) 
               пКонтр+=3*Число(Подстрока(пШКод,Размер(пШКод)-пСч++,1));
            Иначе 
               пКонтр+=Число(Подстрока(пШКод,Размер(пШКод)-пСч++,1));
      
         пКонтр=1000-пКонтр;
         пКонтр=Подстрока(пКонтр,Размер(пКонтр),-1);
#         пШКод+=Текст(пКонтр);
      
         Если(Размер(пШКод)==12)
            {
               pN="!\"#$%&'()*";
               
               пСтрукт="";
               ВыборПо( Подстрока(пШКод,1,1) )
                  {
                     выбор "0":
                     пСтрукт="LLLLLLRRRRRR";
                     выбор "1":
                     пСтрукт="LLGLGGRRRRRR";
                     выбор "2":
                     пСтрукт="LLGGLGRRRRRR";
                     выбор "3":
                     пСтрукт="LLGGGLRRRRRR";
                     выбор "4":
                     пСтрукт="LGLLGGRRRRRR";
                     выбор "5":
                     пСтрукт="LGGLLGRRRRRR";
                     выбор "6":
                     пСтрукт="LGGGLLRRRRRR";
                     выбор "7":
                     пСтрукт="LGLGLGRRRRRR";
                     выбор "8":
                     пСтрукт="LGLGGLRRRRRR";
                     выбор "9":
                     пСтрукт="LGGLGLRRRRRR";
                  }
      
               пСч=1;
               Пока(пСч<Размер(пШКод))
                  {
                     Если(пСч!=1)
                        пРез+=Подстрока(["p"+Подстрока(пСтрукт,пСч,1)],Число(Подстрока(пШКод,пСч+1,1))+1,1);
                     Иначе
                        Если(Подстрока(пШКод,2,1)==0) пРез="`";
                        Иначе пРез=ВНИЗ(Подстрока(pG,Число(Подстрока(пШКод,2,1))+1,1));
                     пСч++;
                  }
               
               пРез+=ВНИЗ(Подстрока(pR,пКонтр+1,1));
               
               пРез=Подстрока(pN,Число(Подстрока(пШКод,1,1))+1,1)+Подстрока(пРез,1,6)+"|"+Подстрока(пРез,7,6);
               
               Вернуть(пРез);
            }
         Иначе
            {
               Если(Подстрока(пШКод,1,1)==0)
                  пРез="`"+Подстрока(пШКод,2,3)+"|";
               Иначе
                  пРез=ВНИЗ(Подстрока(pG,Число(Подстрока(пШКод,1,1))+1,1))+Подстрока(пШКод,2,3)+"|";

               пСч=5;
               Пока(пСч<=Размер(пШКод))
                  {
                     пРез+=Подстрока(pR,Число(Подстрока(пШКод,пСч,1))+1,1);
                     пСч++;
                  }
               
               пРез+=ВНИЗ(Подстрока(pR,пКонтр+1,1));
               
               Вернуть(пРез);
            }
      }
   Иначе Вернуть(-1);
}